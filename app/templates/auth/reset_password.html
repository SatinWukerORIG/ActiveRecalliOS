{% extends "base.html" %}

{% block title %}Reset Password - Active Recall{% endblock %}
{% block page_title %}Reset Your Password{% endblock %}

{% block content %}
<div style="max-width: 400px; margin: 0 auto;">
    <div class="card">
        <h2 style="text-align: center; margin-bottom: 30px;">Set New Password</h2>
        
        <div id="resetAlert" style="display: none;"></div>
        
        <form id="resetPasswordForm">
            <input type="hidden" id="resetToken" value="{{ token }}">
            
            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" required 
                       placeholder="Enter your new password">
                <small style="color: var(--text-secondary); font-size: 12px;">
                    At least 8 characters with letters and numbers
                </small>
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">Confirm New Password:</label>
                <input type="password" id="confirmPassword" required 
                       placeholder="Confirm your new password">
            </div>
            
            <button type="submit" class="btn" style="width: 100%; margin-bottom: 20px;" id="resetBtn">
                Reset Password
            </button>
        </form>
        
        <div style="text-align: center; color: var(--text-secondary);">
            <p>
                <a href="{{ url_for('web.login') }}" style="color: var(--primary-color); text-decoration: none;">
                    Back to Login
                </a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Password confirmation validation
document.getElementById('confirmPassword').addEventListener('input', function() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = this.value;
    
    if (confirmPassword && newPassword !== confirmPassword) {
        this.setCustomValidity('Passwords do not match');
    } else {
        this.setCustomValidity('');
    }
});

// Reset password form handler
document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        showAlert('Passwords do not match', 'error');
        return;
    }
    
    const resetBtn = document.getElementById('resetBtn');
    const originalText = resetBtn.textContent;
    resetBtn.textContent = 'Resetting...';
    resetBtn.disabled = true;
    
    const formData = {
        token: document.getElementById('resetToken').value,
        new_password: newPassword
    };
    
    try {
        const response = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('Password reset successfully! Redirecting to login...', 'success');
            
            // Redirect to login page after success
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            showAlert(result.error || 'Password reset failed', 'error');
        }
    } catch (error) {
        showAlert('Network error. Please try again.', 'error');
    } finally {
        resetBtn.textContent = originalText;
        resetBtn.disabled = false;
    }
});

// Alert function
function showAlert(message, type) {
    const alertDiv = document.getElementById('resetAlert');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertDiv.style.display = 'block';
    
    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}