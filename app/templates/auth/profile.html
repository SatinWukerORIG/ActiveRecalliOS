{% extends "base.html" %}

{% block title %}Profile - Active Recall{% endblock %}
{% block page_title %}Your Profile{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <!-- Profile Information -->
    <div class="card">
        <h2>Profile Information</h2>
        
        <div id="profileAlert" style="display: none;"></div>
        
        <form id="profileForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="firstName">First Name:</label>
                    <input type="text" id="firstName" name="firstName" 
                           value="{{ user.first_name or '' }}">
                </div>
                
                <div class="form-group">
                    <label for="lastName">Last Name:</label>
                    <input type="text" id="lastName" name="lastName" 
                           value="{{ user.last_name or '' }}">
                </div>
            </div>
            
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" value="{{ user.username }}" disabled
                       style="background: #f5f5f5; color: #666;">
                <small style="color: var(--text-secondary); font-size: 12px;">
                    Username cannot be changed
                </small>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address:</label>
                <input type="email" id="email" value="{{ user.email }}" disabled
                       style="background: #f5f5f5; color: #666;">
                <small style="color: var(--text-secondary); font-size: 12px;">
                    Email cannot be changed
                </small>
            </div>
            
            <button type="submit" class="btn" id="updateProfileBtn">
                Update Profile
            </button>
        </form>
    </div>
    
    <!-- Learning Preferences -->
    <div class="card">
        <h2>Learning Preferences</h2>
        
        <form id="preferencesForm">
            <div class="form-group">
                <label style="display: flex; align-items: center; font-weight: normal;">
                    <input type="checkbox" id="focusMode" 
                           {{ 'checked' if user.focus_mode else '' }}
                           style="width: auto; margin-right: 8px;">
                    Enable Focus Mode (reduces notifications)
                </label>
            </div>
            
            <div class="form-group">
                <label for="notificationFrequency">Notification Frequency (minutes):</label>
                <input type="number" id="notificationFrequency" min="5" max="480" 
                       value="{{ user.notification_frequency or 30 }}">
                <small style="color: var(--text-secondary); font-size: 12px;">
                    How often to receive study reminders (5-480 minutes)
                </small>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="sleepStart">Sleep Start Time:</label>
                    <input type="time" id="sleepStart" 
                           value="{{ user.sleep_start.strftime('%H:%M') if user.sleep_start else '' }}">
                </div>
                
                <div class="form-group">
                    <label for="sleepEnd">Sleep End Time:</label>
                    <input type="time" id="sleepEnd" 
                           value="{{ user.sleep_end.strftime('%H:%M') if user.sleep_end else '' }}">
                </div>
            </div>
            
            <button type="submit" class="btn" id="updatePreferencesBtn">
                Update Preferences
            </button>
        </form>
    </div>
    
    <!-- Security -->
    <div class="card">
        <h2>Security</h2>
        
        <div id="securityAlert" style="display: none;"></div>
        
        <form id="passwordForm">
            <div class="form-group">
                <label for="currentPassword">Current Password:</label>
                <input type="password" id="currentPassword" required 
                       placeholder="Enter your current password">
            </div>
            
            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" required 
                       placeholder="Enter your new password">
                <small style="color: var(--text-secondary); font-size: 12px;">
                    At least 8 characters with letters and numbers
                </small>
            </div>
            
            <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password:</label>
                <input type="password" id="confirmNewPassword" required 
                       placeholder="Confirm your new password">
            </div>
            
            <button type="submit" class="btn btn-danger" id="changePasswordBtn">
                Change Password
            </button>
        </form>
        
        <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">
        
        <div>
            <h3>Active Sessions</h3>
            <div id="sessionsList"></div>
            <button onclick="logoutAllSessions()" class="btn" style="background: #666; margin-top: 15px;">
                Logout All Sessions
            </button>
        </div>
    </div>
    
    <!-- Account Actions -->
    <div class="card">
        <h2>Account Actions</h2>
        
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <a href="{{ url_for('web.index') }}" class="btn">Back to Dashboard</a>
            <a href="{{ url_for('web.logout') }}" class="btn" style="background: #666;">Logout</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Profile form handler
document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('updateProfileBtn');
    const originalText = btn.textContent;
    btn.textContent = 'Updating...';
    btn.disabled = true;
    
    const formData = {
        first_name: document.getElementById('firstName').value.trim(),
        last_name: document.getElementById('lastName').value.trim()
    };
    
    try {
        const response = await fetch('/api/auth/profile', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('profileAlert', 'Profile updated successfully!', 'success');
        } else {
            showAlert('profileAlert', result.error || 'Update failed', 'error');
        }
    } catch (error) {
        showAlert('profileAlert', 'Network error. Please try again.', 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

// Preferences form handler
document.getElementById('preferencesForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('updatePreferencesBtn');
    const originalText = btn.textContent;
    btn.textContent = 'Updating...';
    btn.disabled = true;
    
    const formData = {
        focus_mode: document.getElementById('focusMode').checked,
        notification_frequency: parseInt(document.getElementById('notificationFrequency').value),
        sleep_start: document.getElementById('sleepStart').value || null,
        sleep_end: document.getElementById('sleepEnd').value || null
    };
    
    try {
        const response = await fetch('/api/auth/profile', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('profileAlert', 'Preferences updated successfully!', 'success');
        } else {
            showAlert('profileAlert', result.error || 'Update failed', 'error');
        }
    } catch (error) {
        showAlert('profileAlert', 'Network error. Please try again.', 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

// Password form handler
document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;
    
    if (newPassword !== confirmPassword) {
        showAlert('securityAlert', 'New passwords do not match', 'error');
        return;
    }
    
    const btn = document.getElementById('changePasswordBtn');
    const originalText = btn.textContent;
    btn.textContent = 'Changing...';
    btn.disabled = true;
    
    const formData = {
        current_password: document.getElementById('currentPassword').value,
        new_password: newPassword
    };
    
    try {
        const response = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('securityAlert', 'Password changed successfully! You will be logged out.', 'success');
            
            // Redirect to login after password change
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            showAlert('securityAlert', result.error || 'Password change failed', 'error');
        }
    } catch (error) {
        showAlert('securityAlert', 'Network error. Please try again.', 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

// Load active sessions
async function loadSessions() {
    try {
        const response = await fetch('/api/auth/sessions');
        const result = await response.json();
        
        const container = document.getElementById('sessionsList');
        container.innerHTML = '';
        
        if (result.sessions.length === 0) {
            container.innerHTML = '<p style="color: #666;">No active sessions</p>';
            return;
        }
        
        result.sessions.forEach(session => {
            const sessionDiv = document.createElement('div');
            sessionDiv.className = 'card-item';
            sessionDiv.style.cssText = `
                padding: 10px;
                margin: 5px 0;
                border-radius: 6px;
                font-size: 14px;
            `;
            
            const createdDate = new Date(session.created_at).toLocaleDateString();
            const lastActivity = session.last_activity ? 
                new Date(session.last_activity).toLocaleDateString() : 'Never';
            
            sessionDiv.innerHTML = `
                <div><strong>Session ID:</strong> ${session.id}</div>
                <div><strong>Created:</strong> ${createdDate}</div>
                <div><strong>Last Activity:</strong> ${lastActivity}</div>
            `;
            container.appendChild(sessionDiv);
        });
        
    } catch (error) {
        console.error('Error loading sessions:', error);
    }
}

// Logout all sessions
async function logoutAllSessions() {
    if (!confirm('Are you sure you want to logout from all sessions? You will need to login again.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/auth/logout-all', {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('Logged out from all sessions successfully!');
            window.location.href = '/login';
        } else {
            alert('Failed to logout from all sessions');
        }
    } catch (error) {
        alert('Network error. Please try again.');
    }
}

// Alert function
function showAlert(containerId, message, type) {
    const alertDiv = document.getElementById(containerId);
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertDiv.style.display = 'block';
    
    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 5000);
}

// Password confirmation validation
document.getElementById('confirmNewPassword').addEventListener('input', function() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = this.value;
    
    if (confirmPassword && newPassword !== confirmPassword) {
        this.setCustomValidity('Passwords do not match');
    } else {
        this.setCustomValidity('');
    }
});

// Load sessions on page load
loadSessions();
</script>
{% endblock %}